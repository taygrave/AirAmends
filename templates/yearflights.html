{% extends 'base.html' %}
{% block body %}

<h2>{{year}}</h2>
Your flights found for {{year}} are displayed below. Please confirm the report is correct. You can delete flights you never took by hovering over the row. You can add flights that were missed by XXX.<br>
<!-- FIXME: this doesn't reload the page when it goes back tho -->
<a href="/getflights">Go Back</a> 
<br><br>
<script>
// TODO: move javascript into file and source file into this page, either source on bottom or wrap in .ready tag
var addTotals = function(){
    var cTotal = document.getElementById("cTotal");
    var mcTotal = document.getElementById("mTotal");
    var tdEmiss = document.getElementsByClassName("emiss");
    var tdPriced = document.getElementsByClassName("priced");
    var cSum = 0 ; mSum = 0

    for (var i = 0; i < tdEmiss.length; i++) {
        cSum += parseFloat(tdEmiss[i].innerText);
        var unpriced = tdPriced[i].innerText;
        unpriced = parseFloat(unpriced.replace(/\$/,""));
        mSum += unpriced;
    };

    cSum = cSum.toFixed(2);
    mSum = mSum.toFixed(2);
    mSum = mSum.toString();
    cTotal.innerText = cSum;
    mTotal.innerText = ("$" + mSum); 
};

var addFlight = function(e) {
    e.preventDefault();
    console.log("TAY!!")
};

var deleteFlight = function(id, tRow){
    if (confirm("Are you sure you want to delete this flight?")) {
        var formData = new FormData();
        formData.append("id", id)

        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST", "/delete_flight", true);

        xmlhttp.onreadystatechange = function(){
            if (xmlhttp.readyState == 4){
                if (xmlhttp.responseText == "OK"){
                    var row = document.getElementById(tRow);
                    row.remove();
                    addTotals();          

                } else {
                    // TODO update this to be more useful
                    console.log("Flight cannot be removed");
                };
            };
        };
        xmlhttp.send(formData);
} else {
    // Do nothing
}}
</script>

<!-- TODO: need to give unique id to table row - name it after the id (row-id#)
get element by id and remove from table
JS methods Document.getElementById and remove())-->

<table class="table table-striped">
    
    <tr class="info">
        <th>Purchased On:</th><th>Departing From:</th><th>Arriving In:</th><th>CO2e Emissions</th><th>Emissions Value (2015$)</th><th></th>
    </tr>
    
    <tr id="flightadd">
        <form name="flightaddform" id="flightaddform" action="/add_flight" method="GET">
            <td><label for="date"></label><input type="date" value="{{year}}-06-01" name="purchase_date"></td>
            <td><label for="depart"></label><input type="text" name="depart" id="depart"></td>
            <td><label for="arrive"></label><input type="text" name="arrive" id="arrive"></td>
            <td></td>
            <td></td>
            <td><button type="submit" class="btn btn-success" id="flightsubmit">&nbsp;&nbsp;&nbsp;ADD&nbsp;&nbsp;&nbsp;</button></td>
        </form>
    </tr>

    {% for flight in results_list %}
    <tr id={{"row-%d" % flight[4]}}>
        <td>{{flight[0]}}</td>
        <td>{{flight[1]}}</td>
        <td>{{flight[2]}}</td>
        <td class="emiss">{{'%0.2f' % flight[3]}}</td>
        <td class="priced">${{'%0.2f' % (flight[3]*g.carbon_price)}}</td>
        <td><button type="button" class="btn btn-danger" style="visibility: hidden" id="{{flight[4]}}" onclick="deleteFlight('{{flight[4]}}', '{{'row-%d' % flight[4]}}')">DELETE</button></td>
    </tr>
    {% endfor %}
        
    <tr class="info">
        <th>TOTALS</th><th> </th><th> </th><th id="cTotal"></th><th id="mTotal"></th><th></th></tr>
    </tr>

</table>
<br>

<br><br><br><br>
<script>
// ALLOW TEXT INPUT FOR ADDING FLIGHTS TO AUTOCOMPLETE
// var flightAddB = document.getElementById('flightsubmit');
// flightAddB.addEventListener('click', addFlight)

var status = function(result){
    console.log(result);
    console.log("it worked!")
};

$('#flightaddform').submit(function(e)
{
    e.preventDefault(); //STOP default action
    var data = $(this).serialize();
    console.log(data)

    $.get('/add_flight', data, status)
    // $.ajax(
    // {
    //     url : formURL,
    //     type: "POST",
    //     data : postData,
    //     success:function(data, textStatus, jqXHR) 
    //     {
    //         //data: return data from server
    //     },
    //     error: function(jqXHR, textStatus, errorThrown) 
    //     {
    //         //if fails      
    //     }
    // });
});



var data = {{airports_json | safe}};
$(document).ready(function () {
    addTotals();
    $("#arrive").autocomplete({source: data});
    $("#depart").autocomplete({source: data});
  });

$('table').on('mouseover', 'tr', function(ev) {
    $(this).find('.btn.btn-danger').css({'visibility': 'visible'});
}).on('mouseout', 'tr', function(ev) {
    $(this).find('.btn.btn-danger').css({'visibility': 'hidden'});
});



</script>

{% endblock %}